---
title: "CohortSurvival"
format:
  revealjs: 
    theme: [simple, custom_1.scss]
    incremental: true   
    slide-number: true
    chalkboard: true
    preview-links: auto
    margin: 0.07
    code-link: true
    code-line-numbers: false
    height: 900
    width: 1600
execute:
  echo: true
  eval: true
  output: true
  include: true
editor: visual
---

# CohortSurvival

## CohortSurvival

Stable version available on CRAN

```{r, eval=FALSE}
install.packages("CohortSurvival")
```

<br/>

. . .

```{r}
packageVersion("CohortSurvival")
```

<br/>

. . .

Package website can be found at <https://darwin-eu-dev.github.io/CohortSurvival/>

## Reference to the MGUS CDM

```{r}
library(CDMConnector)
library(CohortSurvival)
library(dplyr)
library(ggplot2)
```

We'll create a cdm reference to use our example MGUS2 survival dataset.

```{r}
cdm <- CohortSurvival::mockMGUS2cdm()
cdm
```

## Cohorts for survival

We're going to study risk of death followin MGUS diagnosis. For this we have two cohorts created (outside of the package).

Our first cohort is individuals with an MGUS diagnosis. Note we have added extra columns with patient characteristics (later we can use these for stratification).

```{r}
cdm$mgus_diagnosis %>% 
  glimpse()
```

## Cohorts for survival

We also have a death cohort (this could have been created using [generateDeathCohortSet](https://darwin-eu-dev.github.io/CohortSurvival/reference/generateDeathCohortSet.html))

```{r}
cdm$death_cohort %>% 
  glimpse()
```

## Estimating overall survival

First, we can estimate survival for the overall cohort.

```{r}
MGUS_death <- estimateSingleEventSurvival(cdm,
  targetCohortTable = "mgus_diagnosis",
  outcomeCohortTable = "death_cohort"
)
MGUS_death %>% 
  glimpse()
```

## Estimating overall survival

We can plot our survival results like so.

```{r}
plotSurvival(MGUS_death)
```

## Estimating overall survival

Or we might want to plot cumulative incidence instead.

```{r}
plotSurvival(MGUS_death, cumulativeFailure = TRUE)
```

## Estimating overall survival

Our returned results also have attributes containing information that summarises survival.

```{r}
attr(MGUS_death, "summary") |> 
  glimpse()
```

## Estimating overall survival

```{r}
attr(MGUS_death, "events") |> 
  glimpse()
```

## Estimating overall survival

```{r}
attr(MGUS_death, "attrition") |> 
  glimpse()
```

## With stratification

We can stratify on any additional columns we have added to the target table.

```{r}
MGUS_death <- estimateSingleEventSurvival(cdm,
  targetCohortTable = "mgus_diagnosis",
  outcomeCohortTable = "death_cohort",
  strata = list(c("age_group"),
                c("sex"),
                c("age_group", "sex"))
)
```

## With stratification

```{r, fig.height=6, fig.width=8}
plotSurvival(MGUS_death,
             facet = "strata_name",
             colour = "strata_level")
```

## With stratification

And we also now have summary statistics for each of the strata as well as overall.

```{r}
attr(MGUS_death, "summary") %>%
 glimpse()
```

## Your turn

Using the MGUS mock data:

1.  Estimate risk of death of death over the year following diagnosis stratifying by age group (hint, see followUpDays argument for constraining amount of follow up)

2.  Plot results for age group

## Survival within a cohort

Our outcome can be the cohort end date for our target cohort. Here we're estimating the risk of cohort exit (e.g. to study drug discontinuation)

For this we'll use Eunomia.

```{r}
db <- DBI::dbConnect(duckdb::duckdb(), 
                     dbdir = CDMConnector::eunomia_dir())
cdm <- cdm_from_con(
  con = db,
  cdm_schema = "main", 
  write_schema = "main"
)
```

## Survival within a cohort

```{r}
library(DrugUtilisation)
cdm <- generateIngredientCohortSet(cdm = cdm,
                                   name = "acetaminophen",
                                   ingredient = "acetaminophen")
cohortCount(cdm$acetaminophen)
```

## Survival within a cohort

```{r}
surv <- estimateSingleEventSurvival(cdm, 
                            targetCohortTable = "acetaminophen", 
                            outcomeCohortTable = "acetaminophen", 
                            outcomeDateVariable = "cohort_end_date", 
                            followUpDays = 90)

plotSurvival(surv)
```

## Your turn

Using eunomia:

1.  Estimate risk of discontinuation following initiation with amoxicillin

2.  Plot the overall survival proability

3.  Estimate risk of discontinuation following initiation with amoxicillin stratified by two age groups: 0 to 59 and 60 to 150 (hint, you can add age groups using PatientProfiles)

4.  Plot survival proability stratified by age group

# Extra

## Your turn

1.  Estimate risk of progression for the MGUS cohort

2.  Estimate risk of progression for MGUS cohort, accounting for competing risk of death
